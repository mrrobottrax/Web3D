!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):(t=t||self,r(t["ts-binary-serializer"]={}))}(this,function(t){"use strict";function r(t,r){return t.key.localeCompare(r.key)}function e(t,r){var e=new r;for(var i in e){if(void 0!=t[i])return;var n=e[i];t[i]="function"==typeof n?n.bind(t):n}return t}function i(t,r,e){return void 0===r&&(r=!1),function(i,n){a.register(i,n,t,r,e)}}var n=function(){function t(t,r,e,i){void 0===e&&(e=!1),this.isArray=!1,this.key=t,this.datatype=r,this.isArray=e,this.pclass=i}return t}(),o=function(){function t(){this.m_needSort=!0}return Object.defineProperty(t.prototype,"prototype",{get:function(){return this.m_prototype},set:function(t){this.m_prototype=t,this.pname=this.protoName},enumerable:!0,configurable:!0}),t.prototype.addProperty=function(t,r,e){void 0===e&&(e=!1);for(var i=this.properties,o=0,a=i.length;o<a;o++)if(i[o].key==t)return;i.push(new n(t,r,e)),this.m_needSort=!0},Object.defineProperty(t.prototype,"protoName",{get:function(){return this.prototype.constructor.name},enumerable:!0,configurable:!0}),t.prototype.sortProperty=function(){if(this.m_needSort)return this.properties.sort(function(t,e){return r(t,e)}),this.m_needSort=!1,this},t}();!function(t){t[t.Null=0]="Null",t[t.Float32=1]="Float32",t[t.Float64=2]="Float64",t[t.Int32=3]="Int32",t[t.Int16=4]="Int16",t[t.Int8=5]="Int8",t[t.Uint32=6]="Uint32",t[t.Uint16=7]="Uint16",t[t.Uint8=8]="Uint8",t[t.String=9]="String",t[t.Bool=10]="Bool",t[t.Object=11]="Object",t[t.Float16=12]="Float16",t[t.Map=13]="Map",t[t.Varint32=14]="Varint32",t[t.UVarint32=15]="UVarint32",t[t.TypedArray=16]="TypedArray"}(t.DataType||(t.DataType={}));var a=function(){function r(){}return r.registerInternal=function(t){for(var e=t.prototype,i=r.meta,n=0,a=i.length;n<a;n++)if(i[n].prototype===e)return;var s=new o;s.prototype=e,r.meta.push(s)},r.register=function(e,i,a,s,p){void 0===s&&(s=!1);var f=r.getMetaClass(e);null==f&&((f=new o).prototype=e,f.properties=[],r.meta.push(f));var u=new n(i,a,s);if(a==t.DataType.Object||a==t.DataType.Map)if("number"==typeof p){if(p==t.DataType.Null||p==t.DataType.Object||p==t.DataType.Map)throw new Error("invalid pclass for object/map");u.pclass=p}else u.pclass=r.getMetaClass(p.prototype);else a==t.DataType.TypedArray&&(u.pclass=r.getMetaClass(p.prototype));f.properties.push(u)},r.getMetaClass=function(t){for(var e=r.meta,i=0,n=e.length;i<n;i++){var o=e[i];if(o.prototype===t)return o}return null},r.meta=[],r}();a.registerInternal(Uint8Array),a.registerInternal(Uint16Array),a.registerInternal(Uint32Array),a.registerInternal(Int8Array),a.registerInternal(Int16Array),a.registerInternal(Int32Array),a.registerInternal(Float32Array),a.registerInternal(Float64Array);var s,p=function(){function t(){}return t.ByteToFloat16=function(t){var r=t,e=0!=(r>>15&1),i=r>>10&31,n=1023&r;if(0==i&&0==n)return e?-0:0;if(31==i)return 0==n?e?-1/0:1/0:NaN;var o=0;return o=0==i?n/512:1+n/1024,(e?-1:1)*Math.pow(2,i-15)*o},t.Float16ToByte=function(t){var r=t;if(isNaN(r))return 31745;if(1/r==-1/0)return 32768;if(0===r)return 0;if(r===-1/0)return 64512;if(r===1/0)return 31744;var e=r<0;r=Math.abs(r);var i=Math.floor(r),n=0,o=0;if(i>0){for(;i>0;)n++,i>>=1;n+=14;p=r/(s=Math.pow(2,n-15))-1;o=Math.round(1024*p)}else{var a=32768*r;if((i=Math.floor(a))>0){for(;i>0;)n++,i>>=1;n--}if(0==n)o=Math.round(512*a);else{var s=1<<n,p=a/s-1;o=Math.round(1024*p)}}return(n<<10)+o+(e?32768:0)},t}();!function(t){t.MAX_UINT=1073741824,t.MAX_INT=536870912,t.MIN_INT=-1073741824}(s||(s={}));var f=function(){function t(){this.fastUTF8string=!0}return t}(),u=function(){function r(t){this.m_arrayBufferCurrentSize=r.DEFAULT_BUFFER_SIZE,this.m_pos=0,null==t&&(t=new f),this.m_options=t}return Object.defineProperty(r.prototype,"options",{get:function(){return this.m_options},enumerable:!0,configurable:!0}),r.initialize=function(){for(var r in t.DataType)if(isNaN(Number(r))){var e=t.DataType[r];this.WriteFuncMap[e]="write"+r,this.ReadFuncMap[e]="read"+r}},Object.defineProperty(r.prototype,"pos",{get:function(){return this.m_pos},enumerable:!0,configurable:!0}),r.create=function(t){var e=new r(t),i=new Uint8Array(r.DEFAULT_BUFFER_SIZE);return e.m_arrayBuffer=i,e.m_view=new DataView(i.buffer),e.options.fastUTF8string||(e.writeString=e.writeUTF8Str,e.readString=e.readUTF8Str),e},r.prototype.checkBufferExpand=function(t){void 0===t&&(t=8);var r=this.m_arrayBufferCurrentSize;if(this.m_pos+t>=r){for(var e=r+t;r<e;)r<<=1;var i=this.m_arrayBuffer,n=new Uint8Array(r);n.set(i,0),this.m_arrayBuffer=n,this.m_arrayBufferCurrentSize=r,this.m_view=new DataView(n.buffer,0,r)}},r.createWithView=function(t,e,i,n){var o=new r(n);return t instanceof Uint8Array?(o.m_arrayBuffer=t,o.m_view=new DataView(t.buffer,e,i)):(o.m_arrayBuffer=new Uint8Array(t),o.m_view=new DataView(t,e,i)),o.m_pos=e,o.options.fastUTF8string||(o.writeString=o.writeUTF8Str,o.readString=o.readUTF8Str),o},r.prototype.writeProperty=function(e,i){var n=i.datatype,o=i.isArray,a=i.pclass;if(null==e)return void this.writeType(t.DataType.Null);this.writeType(n);var s=this[r.WriteFuncMap[n]],p=n==t.DataType.Object,f=n==t.DataType.Map;if(!o)return this.checkBufferExpand(8),void(n==t.DataType.TypedArray?Reflect.apply(s,this,[e,a]):p?Reflect.apply(s,this,[e,a]):f?this.writeMap(e,a):Reflect.apply(s,this,[e]));if(!Array.isArray(e)){var u="target property: "+e+" is not an array.";throw new Error(u)}var h=e,l=h.length;if(this.checkBufferExpand(8*l+4),this.writeVarint32(l),p)for(y=0;y<l;y++)Reflect.apply(s,this,[h[y],a]);else if(f)for(y=0;y<l;y++)this.writeMap(h[y],a);else for(var y=0;y<l;y++)s.call(this,h[y],a)},r.prototype.readProperty=function(e){var i=e.datatype,n=this.readType();if(n==t.DataType.Null)return null;if(n!=i)throw new Error("[property: "+e.key+"] type mismatch data:"+t.DataType[n]+"["+n+"] - meta:"+t.DataType[i]+"["+i+"]");var o=this[r.ReadFuncMap[i]],a=i==t.DataType.Object,s=i==t.DataType.Map,p=e.isArray,f=e.pclass;if(!p){if(i==t.DataType.TypedArray)return o.call(this,f);if(a){if(null==f)throw new Error("tmc is null");return o.call(this,f)}if(s){if(null==f)throw new Error("read property tmc missing: "+i);return this.readMap(f)}return o.call(this,null)}var u=this.readVarint32();if(0==u)return[];var h=[];if(a)for(l=0;l<u;l++)h.push(o.call(this,f));else if(s){if(null==f)throw new Error("read property tmc missing: "+i);for(l=0;l<u;l++)h.push(this.readMap(f))}else for(var l=0;l<u;l++)h.push(o.call(this,f));return h},r.prototype.writeMap=function(t,e){if(null==t)return void this.writeUint16(0);var i=Object.getOwnPropertyNames(t);if(i.sort(),null==e)throw new Error("type not found for:"+t);var n=i.length;if(n>65535)throw new Error("map size exceed!");this.writeUint16(n);for(var a=0,s=i.length;a<s;a++){var p=i[a];this.writeString(p);var f=t[p];null==f?this.writeBool(!1):(this.writeBool(!0),e instanceof o?this.writeObject(f,e):this[r.WriteFuncMap[e]].call(this,f))}},r.prototype.readMap=function(t){var e=this.readUint16();if(0==e)return null;for(var i={},n=0;n<e;n++){var a=this.readString();if(null==a)throw new Error("key is null");if(this.readBool())if(t instanceof o)i[a]=this.readObject(t);else{var s=this[r.ReadFuncMap[t]];i[a]=s.call(this,null)}else i[a]=null}return i},r.prototype.writeFloat16=function(t){var r=this.m_view,e=this.m_pos,i=p.Float16ToByte(t);r.setUint16(e,i),this.m_pos+=2},r.prototype.readFloat16=function(){var t=this.m_view.getUint16(this.m_pos),r=p.ByteToFloat16(t);return this.m_pos+=2,r},r.prototype.writeFloat32=function(t){var r=this.m_view,e=this.m_pos;r.setFloat32(e,t),this.m_pos+=4},r.prototype.readFloat32=function(){var t=this.m_view.getFloat32(this.m_pos);return this.m_pos+=4,t},r.prototype.writeFloat64=function(t){var r=this.m_view,e=this.m_pos;try{r.setFloat64(e,t)}catch(t){throw console.log(e,this.m_arrayBufferCurrentSize),t}this.m_pos+=8},r.prototype.readFloat64=function(){var t=this.m_view.getFloat64(this.m_pos);return this.m_pos+=8,t},r.prototype.writeVarint32=function(t){if(t>s.MAX_INT||t<s.MIN_INT)throw new Error("variant32 value range exceeded.");var r=this.m_arrayBuffer,e=this.m_pos;t=t>=0?2*t:-2*t-1;for(;t>=128;){var i=255&t|128;r[e]=i,e++,t>>=7}r[e]=t,this.m_pos=e+1},r.prototype.readVarint32=function(){for(var t=this.m_arrayBuffer,r=this.m_pos,e=t[r],i=0,n=0;(128&e)>0;)n+=(127&e)<<7*i,e=t[r+ ++i];return n+=(127&e)<<7*i,this.m_pos+=i+1,1&n?(n+1)/-2:n/2},r.prototype.writeUVarint32=function(t){if(t>s.MAX_UINT||t<0)throw new Error("variant32 value range exceeded. "+t);for(var r=this.m_arrayBuffer,e=this.m_pos;t>=128;){var i=255&t|128;r[e]=i,e++,t>>=7}r[e]=t,this.m_pos=e+1},r.prototype.readUVarint32=function(){for(var t=this.m_arrayBuffer,r=this.m_pos,e=t[r],i=0,n=0;(128&e)>0;)n+=(127&e)<<7*i,e=t[r+ ++i];return n+=(127&e)<<7*i,this.m_pos+=i+1,n},r.prototype.writeTypedArray=function(t,e){var i=t.length;this.writeInt32(i),this.checkBufferExpand(t.byteLength);for(var n=e.prototype.constructor,o=e.prototype.BYTES_PER_ELEMENT,a=r.TypedArrayWriteMap[n.name],s=this.m_view,p=this.m_pos,f=t.length,u=0;u<f;u++)Reflect.apply(a,s,[p,t[u]]),p+=o;this.m_pos=p},r.prototype.readTypedArray=function(t){for(var e=this.m_view,i=this.readInt32(),n=t.prototype.constructor,o=r.TypedArrrayReadMap[n.name],a=new n(i),s=t.prototype.BYTES_PER_ELEMENT,p=this.m_pos,f=0;f<i;f++)a[f]=Reflect.apply(o,e,[p]),p+=s;return this.m_pos=p,a},r.prototype.writeInt8=function(t){var r=this.m_view,e=this.m_pos;r.setInt8(e,t),this.m_pos++},r.prototype.readInt8=function(){var t=this.m_view.getInt8(this.m_pos);return this.m_pos+=1,t},r.prototype.writeUint8=function(t){var r=this.m_view,e=this.m_pos;r.setUint8(e,t),this.m_pos++},r.prototype.readUint8=function(){var t=this.m_view.getUint8(this.m_pos);return this.m_pos+=1,t},r.prototype.writeInt16=function(t){var r=this.m_view,e=this.m_pos;r.setInt16(e,t),this.m_pos+=2},r.prototype.readInt16=function(){var t=this.m_view.getInt16(this.m_pos);return this.m_pos+=2,t},r.prototype.writeUint16=function(t){var r=this.m_view,e=this.m_pos;r.setUint16(e,t),this.m_pos+=2},r.prototype.readUint16=function(){var t=this.m_view.getUint16(this.m_pos);return this.m_pos+=2,t},r.prototype.writeInt32=function(t){var r=this.m_view,e=this.m_pos;r.setInt32(e,t),this.m_pos+=4},r.prototype.readInt32=function(){var t=this.m_view.getInt32(this.m_pos);return this.m_pos+=4,t},r.prototype.writeUint32=function(t){var r=this.m_view,e=this.m_pos;r.setUint32(e,t),this.m_pos+=4},r.prototype.readUint32=function(){var t=this.m_view.getUint32(this.m_pos);return this.m_pos+=4,t},r.prototype.writeBool=function(t){var r=this.m_view,e=this.m_pos;r.setUint8(e,t?1:0),this.m_pos++},r.prototype.readBool=function(){var t=this.m_view.getUint8(this.m_pos);return this.m_pos++,1==t},r.prototype.writeString=function(t){if(null==t)return void this.writeVarint32(-1);if(""===t)return void this.writeVarint32(0);var r=unescape(encodeURIComponent(t)),e=r.length;this.writeVarint32(e),this.checkBufferExpand(e);for(var i=this.m_view,n=this.m_pos,o=0;o<e;o++)i.setUint8(n++,r.charCodeAt(o));this.m_pos=n},r.prototype.readString=function(){var t=this.readVarint32();if(-1==t)return null;if(0==t)return"";for(var r=new Array(t),e=this.m_pos,i=this.m_arrayBuffer,n=0;n<t;n++)r[n]=i[e++];var o=String.fromCharCode.apply(String,r);return this.m_pos=e,decodeURIComponent(escape(o))},r.prototype.writeUTF8Str=function(t){if(null==t)return void this.writeVarint32(-1);if(""===t)return void this.writeVarint32(0);var r=t.length;this.writeVarint32(r),this.checkBufferExpand(4*r);for(var e=this.m_view,i=this.m_pos,n=0;n<r;n++){var o=t.charCodeAt(n);o<128?e.setUint8(i++,o):o<2048?(e.setUint8(i++,o>>6|192),e.setUint8(i++,128|63&o)):o<65536?(e.setUint8(i++,224|o>>12),e.setUint8(i++,128|o>>6&63),e.setUint8(i++,128|63&o)):(e.setUint8(i++,240|o>>18),e.setUint8(i++,128|o>>12&63),e.setUint8(i++,128|o>>6&63),e.setUint8(i++,128|63&o))}this.m_pos=i},r.prototype.readUTF8Str=function(){var t=this.readVarint32();if(-1==t)return null;if(0==t)return"";for(var r=new Array(t),e=0;e<t;e++){var i=this.readUint8();if(i>>7==0)r[e]=i;else if(i>>5==6){n=this.readUint8();r[e]=(31&i)<<6|63&n}else if(i>>4==14){var n=this.readUint8(),o=this.readUint8();r[e]=(15&i)<<12|(63&n)<<6|63&o}else{var n=this.readUint8(),o=this.readUint8(),a=this.readUint8();r[e]=(7&i)<<18|(63&n)<<12|(63&o)<<6|63&a}}return String.fromCharCode.apply(String,r)},r.prototype.writeType=function(t){this.writeUint8(t)},r.prototype.readType=function(){return this.readUint8()},r.prototype.writeObject=function(t,r){this.serialize(r,t)},r.prototype.readObject=function(t){var r=Object.create(t.prototype);return this.deserialize(r,t),r},r.prototype.serialize=function(r,e){r.sortProperty();for(var i=r.properties,n=0,o=i.length;n<o;n++){var a=i[n];try{this.writeProperty(e[a.key],a)}catch(r){throw console.error("property meta class of "+a.key+" is null, for type: "+t.DataType[a.datatype]),r}}},r.prototype.deserialize=function(t,r){if(null==r)throw new Error("typeMetaClass is null");r.sortProperty();for(var e=r.properties,i=0,n=e.length;i<n;i++){var o=e[i],a=this.readProperty(o);t[o.key]=a}return t},r.DEFAULT_BUFFER_SIZE=512,r.WriteFuncMap={},r.ReadFuncMap={},r.TypedArrayWriteMap={Uint8Array:DataView.prototype.setUint8,Uint16Array:DataView.prototype.setUint16,Uint32Array:DataView.prototype.setUint32,Int8Array:DataView.prototype.setInt8,Int16Array:DataView.prototype.setInt16,Int32Array:DataView.prototype.setInt32,Float32Array:DataView.prototype.setFloat32,Float64Array:DataView.prototype.setFloat64},r.TypedArrrayReadMap={Uint8Array:DataView.prototype.getUint8,Uint16Array:DataView.prototype.getUint16,Uint32Array:DataView.prototype.getUint32,Int8Array:DataView.prototype.getInt8,Int16Array:DataView.prototype.getInt16,Int32Array:DataView.prototype.getInt32,Float32Array:DataView.prototype.getFloat32,Float64Array:DataView.prototype.getFloat64},r}();u.initialize();var h=function(){function t(){this.msgs=[],this.m_ids=0}return t.prototype.emitDebugInfo=function(t,r,e){var i=this.m_lastmsg;if(null!=i&&i.extra===e&&i.iswrite==r&&i.key===t)i.count++;else{var n=new l(this.m_ids,t,r,1,e);this.m_lastmsg=n,this.msgs.push(n)}this.m_ids++},t.prototype.verifyException=function(r){var e=this.msgs,i=r.msgs;if(e.length!=i.length){var n=e.slice(Math.max(0,i.length-10),Math.min(i.length+5,e.length));console.error("--- verify start ---"),console.error(">>> [serialize]"),console.error(t.fmtMsgs(n)),console.error(">>> [derserialize]"),console.log(t.fmtMsgs(i.slice(Math.max(0,i.length-10)))),console.error("--- verify end ---")}},t.fmtMsgs=function(t){var r=[];return t.forEach(function(t){var e=t.extra;null!=e?r.push("\t["+t.id+"] count:"+t.count+" "+t.key+" extra:"+e):r.push("\t["+t.id+"] count:"+t.count+" "+t.key)}),r.join("\n")},t}(),l=function(){function t(t,r,e,i,n){this.count=0,this.id=0,this.key=r,this.iswrite=e,this.count=i,null!=n&&(this.extra=n),this.id=t}return t}(),y=function(){function r(){this.m_dbginfo=new h}return Object.defineProperty(r.prototype,"dbginfo",{get:function(){return this.m_dbginfo},enumerable:!0,configurable:!0}),r.GenPropertyExtra=function(r){if(r.datatype==t.DataType.Object){var e=r.pclass,i=[];return e.properties.forEach(function(t){i.push(t.key)}),r.key+" <"+e.properties.length+">["+i.join(",")+"]"}return""+r.key},r.Gen=function(t){var i=e(t,r),n=i.m_dbginfo;for(var o in t)!function(e){var i=t[e];if("function"==typeof i)e.startsWith("write")?t[e]="writeProperty"===e?function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];n.emitDebugInfo(e,!0,r.GenPropertyExtra(o[1])),Reflect.apply(i,t,o)}:function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n.emitDebugInfo(e,!0),Reflect.apply(i,t,r)}:e.startsWith("read")&&(t[e]="readProperty"===e?function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];n.emitDebugInfo(e,!1,r.GenPropertyExtra(o[0])),Reflect.apply(i,t,o)}:function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return n.emitDebugInfo(e,!1),Reflect.apply(i,t,r)})}(o);return i},r}(),c=function(){function t(){this.fastUTF8string=!0}return t}(),m=function(){function t(){this.fastUTF8string=!0}return t}();!function(t){function r(t,r){var e=Object.getPrototypeOf(t);if(null==e||"Object"==e.constructor.name){if(null==r)throw new Error("param type is required.");e=r.prototype}var i=a.getMetaClass(e);if(null==i){var n="reflect class: "+e.name+" invalid";throw new Error(n)}return i.sortProperty(),i}function e(t){var r=Object.create(t.prototype),e=a.getMetaClass(t.prototype);if(null==e){var i="reflect class "+t.prototype+" invalid.";throw new Error(i)}return e.sortProperty(),[r,e]}function i(t,e,i){var n=r(t,e);null==i&&(i=new m);var o=u.create(i);return o.serialize(n,t),o.m_arrayBuffer.slice(0,o.pos)}function n(t,e,i){var n=r(t,e);null==i&&(i=new m);var o=u.create(i),a=y.Gen(o);return a.serialize(n,t),[a.m_arrayBuffer.slice(0,a.pos),a.dbginfo]}function o(t,r,i){var n=e(r),o=n[0],a=n[1];return null==i&&(i=new m),u.createWithView(t,0,t.byteLength,i).deserialize(o,a)}function s(t,r,i){var n=e(r),o=n[0],a=n[1];null==i&&(i=new m);var s=u.createWithView(t,0,t.byteLength,i),p=y.Gen(s);try{return[p.deserialize(o,a),p.dbginfo]}catch(t){throw null!=i.serializeDbgInfo?i.serializeDbgInfo.verifyException(p.dbginfo):console.error(p.dbginfo),t}}t.Serialize=i,t.SerializeWithDebugInfo=n,t.Deserialize=o,t.DeserializeWithDebugInfo=s}(t.BinarySerializer||(t.BinarySerializer={})),t.BinaryDeserializeOptions=m,t.BinarySerializeOptions=c,t.SerializeField=i,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=BinarySerializer.umd.js.map
