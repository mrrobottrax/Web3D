function sort(t,r){return t.key.localeCompare(r.key)}function Extends(t,r){var e=new r;for(var i in e){if(void 0!=t[i])return;var n=e[i];t[i]="function"==typeof n?n.bind(t):n}return t}function SerializeField(t,r,e){return void 0===r&&(r=!1),function(i,n){TypeReflector.register(i,n,t,r,e)}}var TypeMetaProperty=function(){function t(t,r,e,i){void 0===e&&(e=!1),this.isArray=!1,this.key=t,this.datatype=r,this.isArray=e,this.pclass=i}return t}(),TypeMetaClass=function(){function t(){this.m_needSort=!0}return Object.defineProperty(t.prototype,"prototype",{get:function(){return this.m_prototype},set:function(t){this.m_prototype=t,this.pname=this.protoName},enumerable:!0,configurable:!0}),t.prototype.addProperty=function(t,r,e){void 0===e&&(e=!1);for(var i=this.properties,n=0,a=i.length;n<a;n++)if(i[n].key==t)return;i.push(new TypeMetaProperty(t,r,e)),this.m_needSort=!0},Object.defineProperty(t.prototype,"protoName",{get:function(){return this.prototype.constructor.name},enumerable:!0,configurable:!0}),t.prototype.sortProperty=function(){if(this.m_needSort)return this.properties.sort(function(t,r){return sort(t,r)}),this.m_needSort=!1,this},t}(),DataType;!function(t){t[t.Null=0]="Null",t[t.Float32=1]="Float32",t[t.Float64=2]="Float64",t[t.Int32=3]="Int32",t[t.Int16=4]="Int16",t[t.Int8=5]="Int8",t[t.Uint32=6]="Uint32",t[t.Uint16=7]="Uint16",t[t.Uint8=8]="Uint8",t[t.String=9]="String",t[t.Bool=10]="Bool",t[t.Object=11]="Object",t[t.Float16=12]="Float16",t[t.Map=13]="Map",t[t.Varint32=14]="Varint32",t[t.UVarint32=15]="UVarint32",t[t.TypedArray=16]="TypedArray"}(DataType||(DataType={}));var TypeReflector=function(){function t(){}return t.registerInternal=function(r){for(var e=r.prototype,i=t.meta,n=0,a=i.length;n<a;n++)if(i[n].prototype===e)return;var o=new TypeMetaClass;o.prototype=e,t.meta.push(o)},t.register=function(r,e,i,n,a){void 0===n&&(n=!1);var o=t.getMetaClass(r);null==o&&((o=new TypeMetaClass).prototype=r,o.properties=[],t.meta.push(o));var s=new TypeMetaProperty(e,i,n);if(i==DataType.Object||i==DataType.Map)if("number"==typeof a){if(a==DataType.Null||a==DataType.Object||a==DataType.Map)throw new Error("invalid pclass for object/map");s.pclass=a}else s.pclass=t.getMetaClass(a.prototype);else i==DataType.TypedArray&&(s.pclass=t.getMetaClass(a.prototype));o.properties.push(s)},t.getMetaClass=function(r){for(var e=t.meta,i=0,n=e.length;i<n;i++){var a=e[i];if(a.prototype===r)return a}return null},t.meta=[],t}();TypeReflector.registerInternal(Uint8Array),TypeReflector.registerInternal(Uint16Array),TypeReflector.registerInternal(Uint32Array),TypeReflector.registerInternal(Int8Array),TypeReflector.registerInternal(Int16Array),TypeReflector.registerInternal(Int32Array),TypeReflector.registerInternal(Float32Array),TypeReflector.registerInternal(Float64Array);var Float16=function(){function t(){}return t.ByteToFloat16=function(t){var r=t,e=0!=(r>>15&1),i=r>>10&31,n=1023&r;if(0==i&&0==n)return e?-0:0;if(31==i)return 0==n?e?-1/0:1/0:NaN;var a=0;return a=0==i?n/512:1+n/1024,(e?-1:1)*Math.pow(2,i-15)*a},t.Float16ToByte=function(t){var r=t;if(isNaN(r))return 31745;if(1/r==-1/0)return 32768;if(0===r)return 0;if(r===-1/0)return 64512;if(r===1/0)return 31744;var e=r<0;r=Math.abs(r);var i=Math.floor(r),n=0,a=0;if(i>0){for(;i>0;)n++,i>>=1;n+=14;p=r/(s=Math.pow(2,n-15))-1;a=Math.round(1024*p)}else{var o=32768*r;if((i=Math.floor(o))>0){for(;i>0;)n++,i>>=1;n--}if(0==n)a=Math.round(512*o);else{var s=1<<n,p=o/s-1;a=Math.round(1024*p)}}return(n<<10)+a+(e?32768:0)},t}(),Variant;!function(t){t.MAX_UINT=1073741824,t.MAX_INT=536870912,t.MIN_INT=-1073741824}(Variant||(Variant={}));var BinaryBufferOptions=function(){function t(){this.fastUTF8string=!0}return t}(),BinaryBuffer=function(){function t(r){this.m_arrayBufferCurrentSize=t.DEFAULT_BUFFER_SIZE,this.m_pos=0,null==r&&(r=new BinaryBufferOptions),this.m_options=r}return Object.defineProperty(t.prototype,"options",{get:function(){return this.m_options},enumerable:!0,configurable:!0}),t.initialize=function(){for(var t in DataType)if(isNaN(Number(t))){var r=DataType[t];this.WriteFuncMap[r]="write"+t,this.ReadFuncMap[r]="read"+t}},Object.defineProperty(t.prototype,"pos",{get:function(){return this.m_pos},enumerable:!0,configurable:!0}),t.create=function(r){var e=new t(r),i=new Uint8Array(t.DEFAULT_BUFFER_SIZE);return e.m_arrayBuffer=i,e.m_view=new DataView(i.buffer),e.options.fastUTF8string||(e.writeString=e.writeUTF8Str,e.readString=e.readUTF8Str),e},t.prototype.checkBufferExpand=function(t){void 0===t&&(t=8);var r=this.m_arrayBufferCurrentSize;if(this.m_pos+t>=r){for(var e=r+t;r<e;)r<<=1;var i=this.m_arrayBuffer,n=new Uint8Array(r);n.set(i,0),this.m_arrayBuffer=n,this.m_arrayBufferCurrentSize=r,this.m_view=new DataView(n.buffer,0,r)}},t.createWithView=function(r,e,i,n){var a=new t(n);return r instanceof Uint8Array?(a.m_arrayBuffer=r,a.m_view=new DataView(r.buffer,e,i)):(a.m_arrayBuffer=new Uint8Array(r),a.m_view=new DataView(r,e,i)),a.m_pos=e,a.options.fastUTF8string||(a.writeString=a.writeUTF8Str,a.readString=a.readUTF8Str),a},t.prototype.writeProperty=function(r,e){var i=e.datatype,n=e.isArray,a=e.pclass;if(null==r)return void this.writeType(DataType.Null);this.writeType(i);var o=this[t.WriteFuncMap[i]],s=i==DataType.Object,p=i==DataType.Map;if(!n)return this.checkBufferExpand(8),void(i==DataType.TypedArray?Reflect.apply(o,this,[r,a]):s?Reflect.apply(o,this,[r,a]):p?this.writeMap(r,a):Reflect.apply(o,this,[r]));if(!Array.isArray(r)){var f="target property: "+r+" is not an array.";throw new Error(f)}var u=r,y=u.length;if(this.checkBufferExpand(8*y+4),this.writeVarint32(y),s)for(l=0;l<y;l++)Reflect.apply(o,this,[u[l],a]);else if(p)for(l=0;l<y;l++)this.writeMap(u[l],a);else for(var l=0;l<y;l++)o.call(this,u[l],a)},t.prototype.readProperty=function(r){var e=r.datatype,i=this.readType();if(i==DataType.Null)return null;if(i!=e)throw new Error("[property: "+r.key+"] type mismatch data:"+DataType[i]+"["+i+"] - meta:"+DataType[e]+"["+e+"]");var n=this[t.ReadFuncMap[e]],a=e==DataType.Object,o=e==DataType.Map,s=r.isArray,p=r.pclass;if(!s){if(e==DataType.TypedArray)return n.call(this,p);if(a){if(null==p)throw new Error("tmc is null");return n.call(this,p)}if(o){if(null==p)throw new Error("read property tmc missing: "+e);return this.readMap(p)}return n.call(this,null)}var f=this.readVarint32();if(0==f)return[];var u=[];if(a)for(y=0;y<f;y++)u.push(n.call(this,p));else if(o){if(null==p)throw new Error("read property tmc missing: "+e);for(y=0;y<f;y++)u.push(this.readMap(p))}else for(var y=0;y<f;y++)u.push(n.call(this,p));return u},t.prototype.writeMap=function(r,e){if(null==r)return void this.writeUint16(0);var i=Object.getOwnPropertyNames(r);if(i.sort(),null==e)throw new Error("type not found for:"+r);var n=i.length;if(n>65535)throw new Error("map size exceed!");this.writeUint16(n);for(var a=0,o=i.length;a<o;a++){var s=i[a];this.writeString(s);var p=r[s];null==p?this.writeBool(!1):(this.writeBool(!0),e instanceof TypeMetaClass?this.writeObject(p,e):this[t.WriteFuncMap[e]].call(this,p))}},t.prototype.readMap=function(r){var e=this.readUint16();if(0==e)return null;for(var i={},n=0;n<e;n++){var a=this.readString();if(null==a)throw new Error("key is null");if(this.readBool())if(r instanceof TypeMetaClass)i[a]=this.readObject(r);else{var o=this[t.ReadFuncMap[r]];i[a]=o.call(this,null)}else i[a]=null}return i},t.prototype.writeFloat16=function(t){var r=this.m_view,e=this.m_pos,i=Float16.Float16ToByte(t);r.setUint16(e,i),this.m_pos+=2},t.prototype.readFloat16=function(){var t=this.m_view.getUint16(this.m_pos),r=Float16.ByteToFloat16(t);return this.m_pos+=2,r},t.prototype.writeFloat32=function(t){var r=this.m_view,e=this.m_pos;r.setFloat32(e,t),this.m_pos+=4},t.prototype.readFloat32=function(){var t=this.m_view.getFloat32(this.m_pos);return this.m_pos+=4,t},t.prototype.writeFloat64=function(t){var r=this.m_view,e=this.m_pos;try{r.setFloat64(e,t)}catch(t){throw console.log(e,this.m_arrayBufferCurrentSize),t}this.m_pos+=8},t.prototype.readFloat64=function(){var t=this.m_view.getFloat64(this.m_pos);return this.m_pos+=8,t},t.prototype.writeVarint32=function(t){if(t>Variant.MAX_INT||t<Variant.MIN_INT)throw new Error("variant32 value range exceeded.");var r=this.m_arrayBuffer,e=this.m_pos;t=t>=0?2*t:-2*t-1;for(;t>=128;){var i=255&t|128;r[e]=i,e++,t>>=7}r[e]=t,this.m_pos=e+1},t.prototype.readVarint32=function(){for(var t=this.m_arrayBuffer,r=this.m_pos,e=t[r],i=0,n=0;(128&e)>0;)n+=(127&e)<<7*i,e=t[r+ ++i];return n+=(127&e)<<7*i,this.m_pos+=i+1,1&n?(n+1)/-2:n/2},t.prototype.writeUVarint32=function(t){if(t>Variant.MAX_UINT||t<0)throw new Error("variant32 value range exceeded. "+t);for(var r=this.m_arrayBuffer,e=this.m_pos;t>=128;){var i=255&t|128;r[e]=i,e++,t>>=7}r[e]=t,this.m_pos=e+1},t.prototype.readUVarint32=function(){for(var t=this.m_arrayBuffer,r=this.m_pos,e=t[r],i=0,n=0;(128&e)>0;)n+=(127&e)<<7*i,e=t[r+ ++i];return n+=(127&e)<<7*i,this.m_pos+=i+1,n},t.prototype.writeTypedArray=function(r,e){var i=r.length;this.writeInt32(i),this.checkBufferExpand(r.byteLength);for(var n=e.prototype.constructor,a=e.prototype.BYTES_PER_ELEMENT,o=t.TypedArrayWriteMap[n.name],s=this.m_view,p=this.m_pos,f=r.length,u=0;u<f;u++)Reflect.apply(o,s,[p,r[u]]),p+=a;this.m_pos=p},t.prototype.readTypedArray=function(r){for(var e=this.m_view,i=this.readInt32(),n=r.prototype.constructor,a=t.TypedArrrayReadMap[n.name],o=new n(i),s=r.prototype.BYTES_PER_ELEMENT,p=this.m_pos,f=0;f<i;f++)o[f]=Reflect.apply(a,e,[p]),p+=s;return this.m_pos=p,o},t.prototype.writeInt8=function(t){var r=this.m_view,e=this.m_pos;r.setInt8(e,t),this.m_pos++},t.prototype.readInt8=function(){var t=this.m_view.getInt8(this.m_pos);return this.m_pos+=1,t},t.prototype.writeUint8=function(t){var r=this.m_view,e=this.m_pos;r.setUint8(e,t),this.m_pos++},t.prototype.readUint8=function(){var t=this.m_view.getUint8(this.m_pos);return this.m_pos+=1,t},t.prototype.writeInt16=function(t){var r=this.m_view,e=this.m_pos;r.setInt16(e,t),this.m_pos+=2},t.prototype.readInt16=function(){var t=this.m_view.getInt16(this.m_pos);return this.m_pos+=2,t},t.prototype.writeUint16=function(t){var r=this.m_view,e=this.m_pos;r.setUint16(e,t),this.m_pos+=2},t.prototype.readUint16=function(){var t=this.m_view.getUint16(this.m_pos);return this.m_pos+=2,t},t.prototype.writeInt32=function(t){var r=this.m_view,e=this.m_pos;r.setInt32(e,t),this.m_pos+=4},t.prototype.readInt32=function(){var t=this.m_view.getInt32(this.m_pos);return this.m_pos+=4,t},t.prototype.writeUint32=function(t){var r=this.m_view,e=this.m_pos;r.setUint32(e,t),this.m_pos+=4},t.prototype.readUint32=function(){var t=this.m_view.getUint32(this.m_pos);return this.m_pos+=4,t},t.prototype.writeBool=function(t){var r=this.m_view,e=this.m_pos;r.setUint8(e,t?1:0),this.m_pos++},t.prototype.readBool=function(){var t=this.m_view.getUint8(this.m_pos);return this.m_pos++,1==t},t.prototype.writeString=function(t){if(null==t)return void this.writeVarint32(-1);if(""===t)return void this.writeVarint32(0);var r=unescape(encodeURIComponent(t)),e=r.length;this.writeVarint32(e),this.checkBufferExpand(e);for(var i=this.m_view,n=this.m_pos,a=0;a<e;a++)i.setUint8(n++,r.charCodeAt(a));this.m_pos=n},t.prototype.readString=function(){var t=this.readVarint32();if(-1==t)return null;if(0==t)return"";for(var r=new Array(t),e=this.m_pos,i=this.m_arrayBuffer,n=0;n<t;n++)r[n]=i[e++];var a=String.fromCharCode.apply(String,r);return this.m_pos=e,decodeURIComponent(escape(a))},t.prototype.writeUTF8Str=function(t){if(null==t)return void this.writeVarint32(-1);if(""===t)return void this.writeVarint32(0);var r=t.length;this.writeVarint32(r),this.checkBufferExpand(4*r);for(var e=this.m_view,i=this.m_pos,n=0;n<r;n++){var a=t.charCodeAt(n);a<128?e.setUint8(i++,a):a<2048?(e.setUint8(i++,a>>6|192),e.setUint8(i++,128|63&a)):a<65536?(e.setUint8(i++,224|a>>12),e.setUint8(i++,128|a>>6&63),e.setUint8(i++,128|63&a)):(e.setUint8(i++,240|a>>18),e.setUint8(i++,128|a>>12&63),e.setUint8(i++,128|a>>6&63),e.setUint8(i++,128|63&a))}this.m_pos=i},t.prototype.readUTF8Str=function(){var t=this.readVarint32();if(-1==t)return null;if(0==t)return"";for(var r=new Array(t),e=0;e<t;e++){var i=this.readUint8();if(i>>7==0)r[e]=i;else if(i>>5==6){n=this.readUint8();r[e]=(31&i)<<6|63&n}else if(i>>4==14){var n=this.readUint8(),a=this.readUint8();r[e]=(15&i)<<12|(63&n)<<6|63&a}else{var n=this.readUint8(),a=this.readUint8(),o=this.readUint8();r[e]=(7&i)<<18|(63&n)<<12|(63&a)<<6|63&o}}return String.fromCharCode.apply(String,r)},t.prototype.writeType=function(t){this.writeUint8(t)},t.prototype.readType=function(){return this.readUint8()},t.prototype.writeObject=function(t,r){this.serialize(r,t)},t.prototype.readObject=function(t){var r=Object.create(t.prototype);return this.deserialize(r,t),r},t.prototype.serialize=function(t,r){t.sortProperty();for(var e=t.properties,i=0,n=e.length;i<n;i++){var a=e[i];try{this.writeProperty(r[a.key],a)}catch(t){throw console.error("property meta class of "+a.key+" is null, for type: "+DataType[a.datatype]),t}}},t.prototype.deserialize=function(t,r){if(null==r)throw new Error("typeMetaClass is null");r.sortProperty();for(var e=r.properties,i=0,n=e.length;i<n;i++){var a=e[i],o=this.readProperty(a);t[a.key]=o}return t},t.DEFAULT_BUFFER_SIZE=512,t.WriteFuncMap={},t.ReadFuncMap={},t.TypedArrayWriteMap={Uint8Array:DataView.prototype.setUint8,Uint16Array:DataView.prototype.setUint16,Uint32Array:DataView.prototype.setUint32,Int8Array:DataView.prototype.setInt8,Int16Array:DataView.prototype.setInt16,Int32Array:DataView.prototype.setInt32,Float32Array:DataView.prototype.setFloat32,Float64Array:DataView.prototype.setFloat64},t.TypedArrrayReadMap={Uint8Array:DataView.prototype.getUint8,Uint16Array:DataView.prototype.getUint16,Uint32Array:DataView.prototype.getUint32,Int8Array:DataView.prototype.getInt8,Int16Array:DataView.prototype.getInt16,Int32Array:DataView.prototype.getInt32,Float32Array:DataView.prototype.getFloat32,Float64Array:DataView.prototype.getFloat64},t}();BinaryBuffer.initialize();var BinaryBufDbgInfo=function(){function t(){this.msgs=[],this.m_ids=0}return t.prototype.emitDebugInfo=function(t,r,e){var i=this.m_lastmsg;if(null!=i&&i.extra===e&&i.iswrite==r&&i.key===t)i.count++;else{var n=new BinaryBufDbgMsg(this.m_ids,t,r,1,e);this.m_lastmsg=n,this.msgs.push(n)}this.m_ids++},t.prototype.verifyException=function(r){var e=this.msgs,i=r.msgs;if(e.length!=i.length){var n=e.slice(Math.max(0,i.length-10),Math.min(i.length+5,e.length));console.error("--- verify start ---"),console.error(">>> [serialize]"),console.error(t.fmtMsgs(n)),console.error(">>> [derserialize]"),console.log(t.fmtMsgs(i.slice(Math.max(0,i.length-10)))),console.error("--- verify end ---")}},t.fmtMsgs=function(t){var r=[];return t.forEach(function(t){var e=t.extra;null!=e?r.push("\t["+t.id+"] count:"+t.count+" "+t.key+" extra:"+e):r.push("\t["+t.id+"] count:"+t.count+" "+t.key)}),r.join("\n")},t}(),BinaryBufDbgMsg=function(){function t(t,r,e,i,n){this.count=0,this.id=0,this.key=r,this.iswrite=e,this.count=i,null!=n&&(this.extra=n),this.id=t}return t}(),BinaryBufferDebug=function(){function t(){this.m_dbginfo=new BinaryBufDbgInfo}return Object.defineProperty(t.prototype,"dbginfo",{get:function(){return this.m_dbginfo},enumerable:!0,configurable:!0}),t.GenPropertyExtra=function(t){if(t.datatype==DataType.Object){var r=t.pclass,e=[];return r.properties.forEach(function(t){e.push(t.key)}),t.key+" <"+r.properties.length+">["+e.join(",")+"]"}return""+t.key},t.Gen=function(r){var e=Extends(r,t),i=e.m_dbginfo;for(var n in r)!function(e){var n=r[e];if("function"==typeof n)e.startsWith("write")?r[e]="writeProperty"===e?function(){for(var a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];i.emitDebugInfo(e,!0,t.GenPropertyExtra(a[1])),Reflect.apply(n,r,a)}:function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];i.emitDebugInfo(e,!0),Reflect.apply(n,r,t)}:e.startsWith("read")&&(r[e]="readProperty"===e?function(){for(var a=[],o=0;o<arguments.length;o++)a[o]=arguments[o];i.emitDebugInfo(e,!1,t.GenPropertyExtra(a[0])),Reflect.apply(n,r,a)}:function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];return i.emitDebugInfo(e,!1),Reflect.apply(n,r,t)})}(n);return e},t}(),BinarySerializeOptions=function(){function t(){this.fastUTF8string=!0}return t}(),BinaryDeserializeOptions=function(){function t(){this.fastUTF8string=!0}return t}(),BinarySerializer;!function(t){function r(t,r){var e=Object.getPrototypeOf(t);if(null==e||"Object"==e.constructor.name){if(null==r)throw new Error("param type is required.");e=r.prototype}var i=TypeReflector.getMetaClass(e);if(null==i){var n="reflect class: "+e.name+" invalid";throw new Error(n)}return i.sortProperty(),i}function e(t){var r=Object.create(t.prototype),e=TypeReflector.getMetaClass(t.prototype);if(null==e){var i="reflect class "+t.prototype+" invalid.";throw new Error(i)}return e.sortProperty(),[r,e]}function i(t,e,i){var n=r(t,e);null==i&&(i=new BinaryDeserializeOptions);var a=BinaryBuffer.create(i);return a.serialize(n,t),a.m_arrayBuffer.slice(0,a.pos)}function n(t,e,i){var n=r(t,e);null==i&&(i=new BinaryDeserializeOptions);var a=BinaryBuffer.create(i),o=BinaryBufferDebug.Gen(a);return o.serialize(n,t),[o.m_arrayBuffer.slice(0,o.pos),o.dbginfo]}function a(t,r,i){var n=e(r),a=n[0],o=n[1];return null==i&&(i=new BinaryDeserializeOptions),BinaryBuffer.createWithView(t,0,t.byteLength,i).deserialize(a,o)}function o(t,r,i){var n=e(r),a=n[0],o=n[1];null==i&&(i=new BinaryDeserializeOptions);var s=BinaryBuffer.createWithView(t,0,t.byteLength,i),p=BinaryBufferDebug.Gen(s);try{return[p.deserialize(a,o),p.dbginfo]}catch(t){throw null!=i.serializeDbgInfo?i.serializeDbgInfo.verifyException(p.dbginfo):console.error(p.dbginfo),t}}t.Serialize=i,t.SerializeWithDebugInfo=n,t.Deserialize=a,t.DeserializeWithDebugInfo=o}(BinarySerializer||(BinarySerializer={}));export{BinaryDeserializeOptions,BinarySerializeOptions,BinarySerializer,DataType,SerializeField};
